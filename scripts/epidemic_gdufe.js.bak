/*

## ---------- Surge ---------- ##
[Script]
# > å¹¿ä¸œè´¢ç»å¤§å­¦æ—¥æ£€æ—¥æŠ¥è·å–JWSESSION (student.wozaixiaoyuan.com)
å¹¿ä¸œè´¢ç»å¤§å­¦æ—¥æ£€æ—¥æŠ¥è·å–JWSESSION = type=http-request, pattern=^https?:\/\/student\.wozaixiaoyuan\.com\/health\/(getToday|save)\.json, requires-body=1, max-size=-1, script-path=https://raw.githubusercontent.com/chiupam/surge/main/scripts/epidemic_gdufe.js
# > å¹¿ä¸œè´¢ç»å¤§å­¦æ—¥æ£€æ—¥æŠ¥
å¹¿ä¸œè´¢ç»å¤§å­¦æ—¥æ£€æ—¥æŠ¥ = type=cron, cronexp="0 3 0,7,12,18 * * *", wake-system=1, timeout=180, script-path=https://raw.githubusercontent.com/chiupam/surge/main/scripts/epidemic_gdufe.js

[MITM]
hostname = %APPEND% student.wozaixiaoyuan.com

## ---------- Loon ---------- ##
[Script]
# > å¹¿ä¸œè´¢ç»å¤§å­¦æ—¥æ£€æ—¥æŠ¥è·å–JWSESSION (student.wozaixiaoyuan.com)
http-request ^https?:\/\/student\.wozaixiaoyuan\.com\/health\/(getToday|save)\.json script-path=https://raw.githubusercontent.com/chiupam/surge/main/scripts/epidemic_gdufe.js, requires-body=true, timeout=10, tag=å¹¿ä¸œè´¢ç»å¤§å­¦æ—¥æ£€æ—¥æŠ¥è·å–JWSESSION
# > å¹¿ä¸œè´¢ç»å¤§å­¦æ—¥æ£€æ—¥æŠ¥
cron "0 3 0,7,12,18 * * *" script-path=https://raw.githubusercontent.com/chiupam/surge/main/scripts/epidemic_gdufe.js, tag=å¹¿ä¸œè´¢ç»å¤§å­¦æ—¥æ£€æ—¥æŠ¥

[MITM]
hostname = student.wozaixiaoyuan.com

## ---------- Quantumult X ---------- ##
[rewrite_local]
# > å¹¿ä¸œè´¢ç»å¤§å­¦æ—¥æ£€æ—¥æŠ¥è·å–JWSESSION (student.wozaixiaoyuan.com)
^https?:\/\/student\.wozaixiaoyuan\.com\/health\/(getToday|save)\.json url script-request-header https://raw.githubusercontent.com/chiupam/surge/main/scripts/epidemic_gdufe.js

[task_local]
# > å¹¿ä¸œè´¢ç»å¤§å­¦æ—¥æ£€æ—¥æŠ¥
3 0,7,12,18 * * * https://raw.githubusercontent.com/chiupam/surge/main/scripts/epidemic_gdufe.js, tag=å¹¿ä¸œè´¢ç»å¤§å­¦æ—¥æ£€æ—¥æŠ¥, enabled=true

[mitm]
hostname = student.wozaixiaoyuan.com

regex: ^https?:\/\/student\.wozaixiaoyuan\.com\/health\/(getToday|save)\.json
git: https://github.com/chiupam/surge/blob/main/scripts/epidemic_gdufe.js
raw: https://raw.githubusercontent.com/chiupam/surge/main/scripts/epidemic_gdufe.js
sgmoudule: https://raw.githubusercontent.com/chiupam/surge/main/Surge/Task.sgmodule
boxjs: https://raw.githubusercontent.com/chiupam/surge/main/boxjs/chiupam.boxjs.json

*/

const $ = new Env()
const appName = `ğŸŒ¼ å¹¿ä¸œè´¢ç»å¤§å­¦æ—¥æ£€æ—¥æŠ¥ ğŸŒ¼`
const host = `https://student.wozaixiaoyuan.com/`
const inSchool = $.read("gdufe_inSchool")
const JWSESSION = $.read("gdufe_JWSESSION")
const illustrate = `å¾®ä¿¡ => å°ç¨‹åº => æˆ‘åœ¨æ ¡å›­ => ç™»å½• => (ç‚¹å‡»å¥åº·æ‰“å¡æˆ–æ—¥æ£€æ—¥æŠ¥å¡«æŠ¥)`
const nowHours = new Date().getHours()
typeof $request !== 'undefined' ? set() : main()

function set() {
  const Method = $request.method
  if ($request.headers && (Method == "POST" || Method == "GET")) {
    if ($request.headers.JWSESSION != JWSESSION || !JWSESSION) {
      $.write($request.headers.JWSESSION, "gdufe_JWSESSION")
      $.notice(appName, "ã€æˆåŠŸã€‘å†™å…¥ JWSESSION æˆåŠŸï¼ğŸ‰", $request.headers.JWSESSION)
    } else if ($request.url.indexOf("save") != -1) {
      const body = $response.body.split("&")
      const arr = ["province", "city", "district", "township", "street", "areacode", "latitude", "longitude"]
      const arr_cn = ["æ‰€åœ¨çœä»½", "æ‰€åœ¨åŸå¸‚", "æ‰€åœ¨è¡Œæ”¿åŒº", "æ‰€åœ¨è¡—é“", "æ‰€åœ¨é“è·¯", "æ‰€åœ¨åœ°é‚®æ”¿ç¼–ç ", "çº¬åº¦", "ç»åº¦"]
      var writein = ""
      for (var m = 0; m < body.length; m++) {
        for (var n = 0; n < arr.length; n++) {
          if (body[m].indexOf(arr[n]) != -1) {
            $.write(decodeURIComponent(body[m].split("=")[1]), `gdufe_${arr[n]}`)
            writein += `${arr_cn[n]}ï¼š${decodeURIComponent(body[m].split("=")[1])}\n`
          }
        }
      }
      $.notice(appName, ``, `ã€æˆåŠŸã€‘å†™å…¥æ‰“å¡æ•°æ®æˆåŠŸï¼ğŸ‰`, writein)
    }
  } else {
    $.notice(appName, "", "ã€å¤±è´¥ã€‘æ— æ³•è¯»å– headers å•Šï¼Œè‡ªæŸ¥åŸå› ï¼ğŸ¤¦â€â™‚ï¸")
  }
  $.done()
}

function main() {
  const options = {
    url: `${host}heat/getTodayHeatList.json`,
    headers: {"JWSESSION": JWSESSION}
  }
  $.post(options, (err, resp, data) => {
    if (data) {
      $.log(data)
      const res = JSON.parse(data)
      if (res.code != -10) {
        if (0 <= nowHours && nowHours < 9) {
          i = 0
          period = `æ™¨æ£€`
        } else if (11 <= nowHours && nowHours < 15) {
          i = 1
          period = `åˆæ£€`
        } else if (17 <= nowHours && nowHours < 23) {
          i = 2
          period = `æ™šæ£€`
        } else {
          i = -1
          period = `æœªåœ¨`
        }
        if (i != -1) {
          /*
           * æœªå¼€å§‹ã€æœªæ‰“å¡ {"endTime":"15:00","seq":2,"startTime":"11:00","state":0,"type":0}
           * å·²å¼€å§‹ã€æœªæ‰“å¡ {"endTime":"15:00","seq":2,"startTime":"11:00","state":1,"type":0}
           * å·²å¼€å§‹ã€å·²æ‰“å¡ {"endTime":"15:00","seq":2,"startTime":"11:00","state":1,"type":1}
           * å·²ç»“æŸã€å·²æ‰“å¡ {"endTime":"15:00","seq":2,"startTime":"11:00","state":2,"type":1}
           * state 0 => æœªå¼€å¯ 1 => è¿›è¡Œä¸­ 2 => å·²ç»“æŸ
           *  type 0 => æœªæ‰“å¡ 1 => å·²æ‰“å¡
          */
          const state = res.data[i].state
          const type = res.data[i].type
          const seq = res.data[i].seq
          if (state == 1 && type == 0) { // è¿›è¡Œä¸­ã€æœªæ‰“å¡
            sign(period, seq)
          } else if (state == 1 && type == 1) { // è¿›è¡Œä¸­ã€å·²æ‰“å¡
            $.notice(appName, `ã€é‡å¤ã€‘${period}é‡å¤æ‰“å¡ï¼ğŸ¤¦â€â™‚ï¸`, ``)
            $.done()
          } else {
            $.notice(appName, `ã€ä¸¥é‡ã€‘${period}æ‰“å¡å‡ºç°é”™è¯¯ï¼ğŸ¤¦â€â™‚ï¸`, ``)
            $.done()
          }
        } else {
          $.notice(appName, `ã€å¤±è´¥ã€‘æ‰“å¡å¤±è´¥ï¼ğŸ¤¦â€â™‚ï¸`, `è¯´æ˜ï¼š${period}è§„å®šçš„æ—¶é—´èŒƒå›´å†…ï¼`)
          $.done()
        }  
      } else {
        $.notice(appName, `ã€è¿‡æœŸã€‘æŒ‰ä¸‹åˆ—æ­¥éª¤è·å– JWSESSION å™¢ï¼ğŸ¤¯`, illustrate)
        $.done()
      }
    } else {
      $.notice(appName, `ã€ä¸¥é‡ã€‘APIè¯·æ±‚å¤±è´¥ğŸ¤¯`, err)
      $.log(`APIè¯·æ±‚å¤±è´¥ï¼`)
      $.log(err)
      $.done()
    }
  })
}

function sign(t, e) {
  if (JWSESSION) {
    const answers = `answers=["0"]&`
    const userId = `userId=&`
    const myArea = `myArea=&`
    const temperature = `temperature=36.0&`
    const seq = `seq=${e}&`
    const country = `country=ä¸­å›½&` // å›½å®¶
    const province = `province=${inSchool == "true" ? "å¹¿ä¸œçœ" : $.read("gdufe_province")}&` // çœä»½
    const city = `city=${inSchool == "true" ? "ä½›å±±å¸‚" : $.read("gdufe_city")}&` // åŸå¸‚
    const district = `district=${inSchool == "true" ? "ä¸‰æ°´åŒº" : $.read("gdufe_district")}&` // è¡Œæ”¿åŒº
    const township = `township=${inSchool == "true" ? "äº‘ä¸œæµ·è¡—é“" : $.read("gdufe_township")}&` // è¡—é“
    const street = `street=${inSchool == "true" ? "å¤§å­¦è·¯" : $.read("gdufe_street")}&` // è·¯æ®µ
    const areacode = `areacode=${inSchool == "true" ? "440607" : $.read("gdufe_areacode")}`// é‚®ç¼–ç¼–ç 
    const latitude = `latitude=${inSchool == "true" ? "23.208688735961914" : $.read("gdufe_latitude")}&` // çº¬åº¦
    const longitude = `longitude=${inSchool == "true" ? "112.85215759277344" : $.read("gdufe_longitude")}&` // ç»åº¦
    const body0 = `${answers}${seq}${temperature}${userId}${latitude}${longitude}`
    const body1 = `${country}${province}${city}${district}${township}${street}`
    const body2 = `${myArea}${areacode}`
    const options = {
      url: `${host}heat/save.json`,
      headers: {"JWSESSION": JWSESSION},
      body: encodeURI(`${body0}${body1}${body2}`)
    }
    $.post(options, (err, resp, data) => {
      if (data) {
        $.log(data)
        const res = JSON.parse(data)
        if (res.code == 0) {
          $.notice(appName, `ã€æˆåŠŸã€‘${t}æ‰“å¡æˆåŠŸï¼ğŸ‰`, ``)
        } else {
          $.notice(appName, `ã€ä¸¥é‡ã€‘å‘ç”Ÿå…¶ä»–ç±»å‹é”™è¯¯ï¼ğŸ¤¦â€â™‚ï¸`, `è¿”å›åŒ…ï¼š${data}`)
        }
      } else {
        $.log(`APIè¯·æ±‚å¤±è´¥ï¼`)
        $.log(err)
      }
      $.done()
    })
  } else {
    $.notice(appName, `ã€é”™è¯¯ã€‘è¿˜æ²¡è·å– JWSESSION çš„å€¼ï¼ğŸ¤¦â€â™‚ï¸`, illustrate)
  }
}

function Env() {
  LN = typeof $loon != "undefined"
  SG = typeof $httpClient != "undefined" && !LN
  QX = typeof $task != "undefined"
  read = (key) => {
    if (LN || SG) return $persistentStore.read(key)
    if (QX) return $prefs.valueForKey(key)
  }
  write = (key, val) => {
    if (LN || SG) return $persistentStore.write(key, val); 
    if (QX) return $prefs.setValueForKey(key, val)
  }
  notice = (title, subtitle, message, url) => {
    if (LN) $notification.post(title, subtitle, message, url)
    if (SG) $notification.post(title, subtitle, message, { url: url })
    if (QX) $notify(title, subtitle, message, { "open-url": url })
  }
  get = (url, cb) => {
    if (LN || SG) {$httpClient.get(url, cb)}
    if (QX) {url.method = 'GET'; $task.fetch(url).then((resp) => cb(null, {}, resp.body))}
  }
  post = (url, cb) => {
    if (LN || SG) {$httpClient.post(url, cb)}
    if (QX) {url.method = 'POST'; $task.fetch(url).then((resp) => cb(null, {}, resp.body))}
  }
  put = (url, cb) => {
    if (LN || SG) {$httpClient.put(url, cb)}
    if (QX) {url.method = 'PUT'; $task.fetch(url).then((resp) => cb(null, {}, resp.body))}
  }
  log = (message) => console.log(message)
  done = (value = {}) => {$done(value)}
  return { LN, SG, QX, read, write, notice, get, post, put, log, done }
}
